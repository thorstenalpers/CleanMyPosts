name: "Deploy Release"

on:
  workflow_dispatch: # manual trigger

jobs:
  build:
    runs-on: windows-latest

    env:
      Solution: "src/CleanMyPosts.sln"
      UI_Project: "src/UI/UI.csproj"
      UnitTest_Project: "src/UnitTests/UnitTests.csproj"
      IntegrationTest_Project: "src/IntegrationTests/IntegrationTests.csproj"
      Installer_Script: "installer/Installer.iss"
      FORCE_COLOR: "true"
      DOTNET_LOGGING__CONSOLE__COLORBEHAVIOR: Enabled

    steps:
    - name: Checkout main
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: main

    - name: Install .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.x

    - name: Install Inno Setup
      run: choco install innosetup --yes

    - name: Restore
      run: dotnet restore "${{ env.Solution }}"

    - name: Build
      run: dotnet build "${{ env.Solution }}" --configuration Release --no-restore

    - name: Run Unit Tests
      run: dotnet test "${{ env.UnitTest_Project }}" --configuration Release --logger "console;verbosity=detailed"

    - name: Run Integration Tests
      run: dotnet test "${{ env.IntegrationTest_Project }}" --configuration Release --logger "console;verbosity=detailed"

    - name: Extract Version
      id: get_version
      shell: pwsh
      run: |
        $content = Get-Content "${{ env.UI_Project }}" -Raw
        if ($content -match '<Version>\s*(.+?)\s*</Version>') {
          $fullVersion = $matches[1].Trim()
          $semverOnly = $fullVersion -replace '\+.*$', '' 
          echo "VERSION=$semverOnly" | Out-File -FilePath $env:GITHUB_ENV -Append
        }

    - name: Show Version
      run: echo "VERSION is ${{ env.VERSION }}"

    - name: Publish x64
      run: |
        dotnet publish "${{ env.UI_Project }}" -c Release -r win-x64 --self-contained true `
            /p:Version=${{ env.VERSION }} `
            /p:AssemblyVersion=${{ env.VERSION }} `
            /p:FileVersion=${{ env.VERSION }}.0 `
            /p:InformationalVersion=${{ env.VERSION }} `
            -o artifacts/publish-x64

    - name: Publish Single-File x64
      run: |
        dotnet publish "${{ env.UI_Project }}" `
            -c Release -r win-x64 --self-contained true `
            /p:PublishSingleFile=true `
            /p:IncludeNativeLibrariesForSelfExtract=true `
            /p:PublishTrimmed=false `
            /p:Version=${{ env.VERSION }} `
            /p:AssemblyVersion=${{ env.VERSION }} `
            /p:FileVersion=${{ env.VERSION }}.0 `
            /p:InformationalVersion=${{ env.VERSION }} `
            -o artifacts/publish-single

    - name: Build Installer x64
      run: |
        iscc "/DMyAppVersion=${{ env.VERSION }}" "/DMyAppExePath=..\\artifacts\\publish-x64\\*" "${{ env.Installer_Script }}"

    - name: Copy Installer Exe to Artifacts
      run: |
        mkdir artifacts\installer
        copy installer\Output\CleanMyPosts-Installer-${{ env.VERSION }}-win-x64.exe artifacts\installer\

    - name: Copy Standalone Single-File EXE to Artifacts
      run: |
        mkdir artifacts\standalone
        copy artifacts\publish-single\CleanMyPosts.exe artifacts\standalone\CleanMyPosts-${{ env.VERSION }}-win-x64.exe

    - name: Clone update-feed branch to separate folder
      run: |
        git clone --branch update-feed --single-branch https://github.com/${{ github.repository }} update-feed || mkdir update-feed

    - name: Copy update.xml from update-feed or fallback
      shell: pwsh
      run: |
        if (Test-Path "update-feed/update.xml") {
          Copy-Item "update-feed/update.xml" "update.xml"
        } else {
          "No update.xml found in update-feed branch." | Out-File update.xml
        }

    - name: Fetch update-original.xml from remote
      shell: pwsh
      run: |
        $originalUrl = "https://raw.githubusercontent.com/thorstenalpers/CleanMyPosts/update-feed/update-original.xml"
        Invoke-WebRequest -Uri $originalUrl -OutFile "update-original.xml"

    - name: Generate update-installer.xml and update-single.xml from original
      shell: pwsh
      run: |
        $version = "${{ env.VERSION }}"
        $repo = "${{ github.repository }}"
        $baseUrl = "https://github.com/$repo/releases/download/v$version"
        $changelogUrl = "https://github.com/$repo/releases/tag/v$version"

        $template = Get-Content "update-original.xml" -Raw

        $installerUrl = "$baseUrl/CleanMyPosts-Installer-$version-win-x64.exe"
        $installerXml = $template `
          -replace "{{VERSION}}", $version `
          -replace "{{INSTALLER_URL}}", $installerUrl `
          -replace "{{CHANGELOG_URL}}", $changelogUrl
        $installerXml | Set-Content -Path "artifacts/update-installer.xml" -Encoding UTF8

        $singleUrl = "$baseUrl/CleanMyPosts-$version-win-x64.exe"
        $singleXml = $template `
          -replace "{{VERSION}}", $version `
          -replace "{{INSTALLER_URL}}", $singleUrl `
          -replace "{{CHANGELOG_URL}}", $changelogUrl
        $singleXml | Set-Content -Path "artifacts/update-single.xml" -Encoding UTF8

    - name: Configure Git Credentials for update-feed push
      run: |
        echo "https://${{ secrets.GH_APIKEY }}@github.com" > $env:USERPROFILE\.git-credentials
        git config --global credential.helper store
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"

    - name: Commit and push update files to update-feed branch
      shell: bash
      run: |
        cd update-feed
        cp ../artifacts/update-installer.xml update-installer.xml
        cp ../artifacts/update-single.xml update-single.xml

        git add update-installer.xml update-single.xml

        if git diff --cached --quiet; then
          echo "No changes in update files; skipping commit"
        else
          git commit -m "Update appcast files for version ${{ env.VERSION }}"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} update-feed --force
        fi

    - name: Create Git Tag
      run: |
        git tag -a "v${{ env.VERSION }}" -m "Release v${{ env.VERSION }}"
        git push origin "v${{ env.VERSION }}"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v${{ env.VERSION }}"
        name: "CleanMyPosts ${{ env.VERSION }}"
        body_path: ./release-notes/v${{ env.VERSION }}.md
        files: |
          artifacts/installer/CleanMyPosts-Installer-${{ env.VERSION }}-win-x64.exe
          artifacts/standalone/CleanMyPosts-${{ env.VERSION }}-win-x64.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
