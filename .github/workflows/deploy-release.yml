name: "Deploy Release"

on:
  workflow_dispatch: # manual trigger

jobs:
  build:
    runs-on: windows-latest

    env:
      Solution: "src/CleanMyPosts.sln"
      UI_Project: "src/UI/UI.csproj"
      UnitTest_Project: "src/UnitTests/UnitTests.csproj"
      IntegrationTest_Project: "src/IntegrationTests/IntegrationTests.csproj"
      Installer_Script: "installer/Installer.iss"
      FORCE_COLOR: "true"
      DOTNET_LOGGING__CONSOLE__COLORBEHAVIOR: Enabled

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 
        ref: main

    - name: Install .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.x

    - name: Install Inno Setup
      run: choco install innosetup --yes

    - name: Restore
      run: dotnet restore "${{ env.Solution }}"

    - name: Build
      run: dotnet build "${{ env.Solution }}" --configuration Release --no-restore

    - name: Run Unit Tests
      run: dotnet test "${{ env.UnitTest_Project }}" --configuration Release --logger "console;verbosity=detailed" --filter "TestCategory!=Long-Running"

    - name: Run Integration Tests
      run: dotnet test "${{ env.IntegrationTest_Project }}" --configuration Release --logger "console;verbosity=detailed"

    - name: Extract Version
      id: get_version
      shell: pwsh
      run: |
        $content = Get-Content "${{ env.UI_Project }}" -Raw
        if ($content -match '<Version>\s*(.+?)\s*</Version>') {
          $version = $matches[1].Trim()
          echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append
        } else {
          throw "Version not found in project file"
        }

    - name: Publish Single EXE
      run: |
        dotnet publish "${{ env.UI_Project }}" -c Release -r win-x64 --self-contained true `
          /p:PublishSingleFile=true `
          /p:IncludeAllContentForSelfExtract=true `
          /p:EnableCompressionInSingleFile=true `
          -o artifacts/single-exe

    - name: List published files
      run: dir artifacts/single-exe

    - name: Rename Standalone EXE for Release
      shell: pwsh
      run: |
        $src = "artifacts/single-exe/CleanMyPosts.exe"
        $dst = "artifacts/single-exe/CleanMyPosts-standalone.exe"

        if (-Not (Test-Path $src)) {
          Write-Error "File $src not found!"
          exit 1
        }
        if (Test-Path $dst) {
          Remove-Item $dst -Force
        }
        Rename-Item -Path $src -NewName $dst

    - name: Build Setup EXE
      run: |
        iscc "/DMyAppVersion=${{ env.VERSION }}" "/DMyAppExePath=..\\artifacts\\single-exe\\*" "${{ env.Installer_Script }}"

    - name: Copy Setup EXE to Artifacts
      run: |
        mkdir -p artifacts/setup
        copy installer\Output\CleanMyPosts-Setup-${{ env.VERSION }}.exe artifacts\setup\

    - name: Generate update.xml
      shell: pwsh
      run: |
        $version = "${{ env.VERSION }}"
        $repo = "${{ github.repository }}"
        $baseUrl = "https://github.com/$repo/releases/download/v$version"
        $installerUrl = "$baseUrl/CleanMyPosts-Setup-$version.exe"
        $changelogUrl = "https://github.com/$repo/releases/tag/v$version"
        $xmlContent = @"
            <?xml version='1.0' encoding='utf-8'?>
            <updates>
              <application>
                <name>CleanMyPosts</name>
                <version>$version</version>
                <url>$installerUrl</url>
                <changelog>$changelogUrl</changelog>
              </application>
            </updates>
            "@
        $xmlContent | Set-Content -Path "artifacts/update.xml" -Encoding UTF8

    - name: Configure Git Credentials
      run: |
        echo "https://${{ secrets.GH_APIKEY }}@github.com" > $env:USERPROFILE\.git-credentials
        git config --global credential.helper store
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"

    - name: Push update.xml to update-feed branch
      run: |
        git fetch origin update-feed || echo "No update-feed branch yet"
        if git show-ref --verify --quiet refs/heads/update-feed; then
          git checkout update-feed
        else
          git checkout --orphan update-feed
          git rm -rf .
        fi

        cp artifacts/update.xml update.xml
        git add update.xml

        if git diff --cached --quiet; then
          echo "No changes in update.xml; skipping commit"
        else
          git commit -m "Update appcast for version ${{ env.VERSION }}"
          git push origin update-feed --force
        fi

    - name: Create Git Tag
      run: |
        git tag -a "v${{ env.VERSION }}" -m "Release v${{ env.VERSION }}"
        git push origin "v${{ env.VERSION }}"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v${{ env.VERSION }}"
        name: "CleanMyPosts ${{ env.VERSION }}"
        body_path: ./release-notes/v${{ env.VERSION }}.md
        files: |
          artifacts/single-exe/CleanMyPosts-standalone.exe
          artifacts/setup/CleanMyPosts-Setup-${{ env.VERSION }}.exe
          artifacts/update.xml
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
